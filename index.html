import base64
import os
import re
import json

# === 1. æ–‡ä»¶é…ç½® ===
WASM_FILE = "dunjia_core.wasm"
JS_FILE = "dunjia_core.js"
EPHE_FILE = "sepl_18.se1" 
TXT_FILE = "ã€Šç„¦æ°æ˜“æ—æ³¨ã€‹.txt"
YILIN_DATA_FILE = "yilin_data.js"
# è¾“å‡ºæ–‡ä»¶åï¼šV14 åˆç’§çº¯ç²¹ç‰ˆ
OUTPUT_FILE = "Dunjia_V14_HeBi_Pure.html"

# === 2. è¯»å–å·¥å…· ===
def read_b64(path):
    print(f"æ­£åœ¨ç¼–ç : {path}")
    if not os.path.exists(path): return ""
    with open(path, "rb") as f: return base64.b64encode(f.read()).decode('utf-8')

def read_text(path):
    print(f"æ­£åœ¨è¯»å–: {path}")
    if not os.path.exists(path): return ""
    encodings = ["utf-8", "gb18030", "gbk", "big5", "utf-16"]
    for enc in encodings:
        try:
            with open(path, "r", encoding=enc) as f: return f.read()
        except: continue
    return ""

# === 3. æ˜“æ—æ•°æ®å¤„ç† ===
def parse_yilin_txt(path):
    content = read_text(path)
    if not content: return None
    print(f"æ­£åœ¨è§£ææ˜“æ—: {path} ...")
    data = {}
    content = content.replace('\ufeff', '').replace("ï¼š", ":").replace("?", "").replace("ã€€", " ")
    pattern = re.compile(r'(?:^|\n).*?([\u4e00-\u9fa5]{1,3})\s*[ä¹‹\s]\s*([\u4e00-\u9fa5]{1,3})(?:[:\s]*)(.*?)(?=(?:^|\n).*?[\u4e00-\u9fa5]+\s*[ä¹‹\s]\s*[\u4e00-\u9fa5]+|$)', re.DOTALL)
    matches = pattern.findall(content)
    map_table = {
        "å¤§é":"å¤§è¿‡", "å¤§è¿‡":"å¤§é", "å°é":"å°è¿‡", "å°è¿‡":"å°é",
        "é¯":"é", "é":"é¯", "æ†":"æ’", "æ’":"æ†", 
        "è¨Ÿ":"è®¼", "è®¼":"è¨Ÿ", "è¬™":"è°¦", "è°¦":"è¬™", "è‡¨":"ä¸´", "ä¸´":"è‡¨", 
        "å‰":"å‰¥", "å‰¥":"å‰", "è§€":"è§‚", "è§‚":"è§€", "å¤¬":"å†³", "å†³":"å¤¬", 
        "è±":"ä¸°", "ä¸°":"è±", "æ":"æŸ", "æŸ":"æ", "èˆ‡":"ä¸", "ä¸":"èˆ‡", 
        "è ±":"è›Š", "è›Š":"è ±", "ç‚º":"ä¸º", "ä¸º":"ç‚º", "é•·":"é•¿", "é•¿":"é•·",
        "è±«":"è±«", "å¤":"å¤", "éœ‡":"éœ‡", "ä¹¾":"ä¹¾", "æ™‹":"æ™‰", "æ™‰":"æ™‹",
        "å¾©":"å¤", "å¤":"å¾©"
    }
    for ben, zhi, body in matches:
        ben, zhi, body = ben.strip(), zhi.strip(), body.strip()
        parts = re.split(r'[â—‹\n\r]', body, 1)
        poem = parts[0].strip()
        desc = parts[1].strip() if len(parts) > 1 else ""
        if desc.startswith("â—‹") or desc.startswith("æ³¨") or desc.startswith("æŒ‰"): desc = desc[1:]
        if len(ben) > 4 or len(zhi) > 4: continue 
        if ben not in data: data[ben] = {}
        data[ben][zhi] = {"poem": poem, "desc": desc}
        b_alt = map_table.get(ben, ben)
        z_alt = map_table.get(zhi, zhi)
        pairs = [(ben, zhi), (ben, z_alt), (b_alt, zhi), (b_alt, z_alt)]
        for b, z in pairs:
            if b not in data: data[b] = {}
            if z not in data[b]: data[b][z] = {"poem": poem, "desc": desc}
    return json.dumps(data, ensure_ascii=False)

def process_data_logic():
    json_data = parse_yilin_txt(TXT_FILE)
    if json_data: return f"window.YILIN_BOOK = Object.assign(window.YILIN_BOOK||{{}}, {json_data});"
    if os.path.exists(YILIN_DATA_FILE):
        content = read_text(YILIN_DATA_FILE)
        clean = re.sub(r'^(export\s+default|const\s+\w+|var\s+\w+|let\s+\w+|module\.exports\s*=)\s*', '', content).strip()
        if clean.endswith(';'): clean = clean[:-1]
        return f"try {{ window.YILIN_BOOK = Object.assign(window.YILIN_BOOK||{{}}, {clean}); }} catch(e) {{}}"
    return "console.warn('æ— æ˜“æ—æ•°æ®');"

# === 4. HTML æ¨¡æ¿ (çº¯ç²¹ç‰ˆ) ===
HTML_TEMPLATE = r"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤©æ¢ Â· åˆç’§ V14 (çº¯ç²¹ç‰ˆ)</title>
<style>
    :root { --bg: #0f0f13; --panel: #18181e; --border: #333; --text: #e0e0e0; --accent: #d4af37; }
    body { background: var(--bg); color: var(--text); font-family: "Segoe UI", "Microsoft YaHei", sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    .container { width: 100%; max-width: 720px; display: flex; flex-direction: column; gap: 15px; }
    
    /* é¡¶éƒ¨æ§åˆ¶æ  */
    .controls { background: var(--panel); padding: 15px; border: 1px solid var(--border); border-radius: 8px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    input, select { background: #222; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; font-family: Consolas; }
    button { background: var(--accent); color: #000; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }
    
    /* æ ¸å¿ƒä¿¡æ¯å¤´ */
    .header { background: var(--panel); padding: 15px; border-radius: 8px; border-top: 3px solid var(--accent); text-align: center; }
    .h-time { font-size: 1.2rem; font-weight: bold; color: var(--accent); }
    .h-solar { font-size: 0.9rem; color: #2ecc71; margin-top:5px; font-family: Consolas; }
    
    /* V13 å¯è§†åŒ–å®¹å™¨ (ä¿ç•™) */
    .viz-container { display:flex; gap:10px; margin: 5px 0; height: 320px; width: 100%; }
    .viz-box { flex:1; background:#1a1a1e; border:1px solid #333; border-radius:8px; position:relative; overflow:hidden; }
    .viz-title { position:absolute; top:10px; left:10px; font-size:0.8rem; z-index:10; font-weight:bold; letter-spacing:1px; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:4px; }

    /* å…«å­—ç›’å­ (ä¿ç•™ V12 å†œå†) */
    .bazi-box { background: #1a1a1a; border: 1px solid #444; border-radius: 8px; padding: 15px; position: relative; }
    .lunar-tag { position: absolute; top: 10px; right: 15px; font-size: 0.8rem; color: #d4af37; border: 1px solid #d4af37; padding: 2px 8px; border-radius: 12px; }
    .bazi-grid { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; gap: 5px; margin-top: 15px; }
    .bz-col { background: #252525; padding: 8px; border-radius: 4px; border: 1px solid #333; }
    .bz-char { font-size: 1.5rem; font-weight: bold; color: #fff; font-family: "KaiTi"; }
    .qiyun-info { font-size: 0.85rem; color: #2ecc71; margin: 10px 0 5px 0; border-top: 1px solid #333; padding-top: 8px; font-weight: bold; }
    .dayun-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; scrollbar-width: thin; scrollbar-color: #444 #222; }
    .dy-card { background: #222; border: 1px solid #333; border-radius: 4px; padding: 6px 10px; min-width: 55px; text-align: center; flex-shrink: 0; }
    .dy-gz { font-weight: bold; color: var(--accent); font-size: 1rem; font-family: "KaiTi"; }
    .dy-age { font-size: 0.7rem; color: #888; }
    
    /* ç‰©ç†æ—¥å¿— (ç®€åŒ–æ˜¾ç¤º) */
    .info-box { font-size:0.8rem; color:#666; margin-top:5px; padding:5px; text-align: center; }

    /* æ˜“æ—ç›’å­ */
    .yilin-box { background: #151515; border: 1px solid #444; border-radius: 8px; padding: 25px; color: #ccc; margin-top: 10px; border-bottom: 3px solid var(--accent); display:flex; justify-content: center; align-items: center; flex-direction: column; }
    .gua-display { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
    .gua-symbol { font-size: 5rem; line-height: 1; font-family: "Segoe UI Symbol", "Arial Unicode MS"; color: #fff; text-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
    .gua-arrow { font-size: 2rem; color: #666; }
    .gua-meta { text-align: center; font-family: "KaiTi"; font-size: 1.2rem; color: var(--accent); margin-top: 5px; }
    .gua-text { text-align: center; font-family: "KaiTi"; font-size: 1.4rem; color: #f1c40f; margin: 15px 0; text-shadow: 0 0 10px rgba(241, 196, 15, 0.3); max-width: 90%; }
    .gua-desc { text-align: center; font-size: 0.9rem; color: #888; margin-top: 5px; max-width: 80%; line-height: 1.6; }

    #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; color: var(--accent); flex-direction: column; }
</style>
</head>
<body>

<div id="loading"><h2>å¤©æ¢ Â· åˆç’§ V14 (çº¯ç²¹ç‰ˆ)</h2><div id="err-log"></div></div>

<div class="container" id="main-ui" style="display:none">
    <div class="controls">
        <input type="datetime-local" id="inp-time" step="1">
        <button onclick="getLocation()" title="å®šä½">ğŸ“</button>
        <input type="number" id="inp-lon" value="116.4074" style="width:70px" title="ç»åº¦">
        <input type="number" id="inp-lat" value="39.9042" style="width:70px" title="çº¬åº¦">
        <select id="inp-gender" style="width:50px"><option value="1">ç”·</option><option value="0">å¥³</option></select>
        <select id="inp-method" title="èµ·å¦æ–¹å¼"><option value="guaqi" selected>ç‰©ç†(å…ˆå¤©å¦æ°”)</option><option value="time">æ•°ç†(æ—¶é—´å¹²æ”¯)</option></select>
        <button onclick="calc()">æ’ç›˜</button>
    </div>

    <div class="header" id="header-info"></div>

    <div class="viz-container">
        <div class="viz-box">
            <div class="viz-title" style="color:#d4af37;">å¤©è±¡ Â· é»„é“åæ ‡</div>
            <canvas id="canvas-astro" width="340" height="320" style="width:100%; height:100%;"></canvas>
        </div>
        <div class="viz-box">
            <div class="viz-title" style="color:#3498db;">æ•°ç† Â· æ´›ä¹¦ä¹å®«</div>
            <canvas id="canvas-luoshu" width="340" height="320" style="width:100%; height:100%;"></canvas>
        </div>
    </div>

    <div class="bazi-box">
        <div class="lunar-tag" id="lunar-date">å†œå†è®¡ç®—ä¸­...</div>
        <div class="bazi-grid">
            <div class="bz-col"><span class="bz-title">å¹´æŸ±</span><div class="bz-char" id="bz-y"></div></div>
            <div class="bz-col"><span class="bz-title">æœˆæŸ±</span><div class="bz-char" id="bz-m"></div></div>
            <div class="bz-col"><span class="bz-title">æ—¥æŸ±</span><div class="bz-char" id="bz-d"></div></div>
            <div class="bz-col"><span class="bz-title">æ—¶æŸ±</span><div class="bz-char" id="bz-h"></div></div>
        </div>
        <div class="qiyun-info" id="qiyun-info"></div>
        <div class="dayun-scroll" id="dayun-list"></div>
    </div>

    <div class="info-box" id="phy-log"></div>

    <div class="yilin-box">
        <div style="font-size:0.9rem; color:#666; margin-bottom:15px; letter-spacing:1px;">ç„¦æ°æ˜“æ— Â· ç‰©ç†èµ·å¦</div>
        <div class="gua-display">
            <div><div class="gua-symbol" id="g-sym-ben"></div><div class="gua-meta" id="g-name-ben"></div></div>
            <div class="gua-arrow">â”</div>
            <div><div class="gua-symbol" id="g-sym-zhi"></div><div class="gua-meta" id="g-name-zhi"></div></div>
        </div>
        <div class="gua-text" id="y-poem"></div>
        <div class="gua-desc" id="y-desc"></div>
    </div>
</div>

<script>
window.onerror = function(msg,u,l) { document.getElementById('err-log').innerText += `Err: ${msg} (L${l})\n`; };
window.WASM_DATA = "___WASM_PLACEHOLDER___";
window.EPHE_DATA = "___EPHE_PLACEHOLDER___";
window.YILIN_BOOK = { "è±«": { "å°è¿‡": { "poem": "åŒ—å±±æœ‰æ£—ï¼Œä½¿å”æ“ç¨¿ã€‚äººçš†å¾—å¯¦ï¼Œæˆ‘ç¨æŠ±è—ã€‚", "desc": "ï¼ˆå†…ç½®ä¿®å¤æ•°æ®ï¼‰" } }, "ä¹¾": { "ä¹¾": { "poem": "é“æ¶‰å¤šå²ï¼Œèª¤å…¥ç©ºè™›ã€‚", "desc": "æ±‚è²¡ä¸åˆ©" } } };
</script>

<script>
___YILIN_DATA_PLACEHOLDER___
</script>

<script>
try { ___JS_PLACEHOLDER___ } catch(e) { console.error("JSæ³¨å…¥å¤±è´¥", e); }
</script>

<script>
let core = null;
const GAN = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
const ZHI = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
const MONTH_CN = ["æ­£","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹","å","åä¸€","è…Š"];
const DAY_CN = ["åˆä¸€","åˆäºŒ","åˆä¸‰","åˆå››","åˆäº”","åˆå…­","åˆä¸ƒ","åˆå…«","åˆä¹","åˆå","åä¸€","åäºŒ","åä¸‰","åå››","åäº”","åå…­","åä¸ƒ","åå…«","åä¹","äºŒå","å»¿ä¸€","å»¿äºŒ","å»¿ä¸‰","å»¿å››","å»¿äº”","å»¿å…­","å»¿ä¸ƒ","å»¿å…«","å»¿ä¹","ä¸‰å"];
const GUA_64 = ["ä¹¾","å¤","å±¯","è’™","éœ€","è¨Ÿ","å¸«","æ¯”","å°ç•œ","å±¥","æ³°","å¦","åŒäºº","å¤§æœ‰","è¬™","è±«","éš¨","è ±","è‡¨","è§€","å™¬å—‘","è³","å‰","å¾©","æ— å¦„","å¤§ç•œ","é ¤","å¤§é","å","ç¦»","å’¸","æ’","é¯","å¤§å£¯","æ™‰","æ˜å¤·","å®¶äºº","ç½","è¹‡","è§£","æ","ç›Š","å¤¬","å§¤","èƒ","å‡","å›°","äº•","é©","é¼","éœ‡","è‰®","æ¼¸","æ­¸å¦¹","è±","æ—…","å·½","å…Œ","æ¸™","ç¯€","ä¸­å­š","å°é","æ—¢æ¿Ÿ","æœªæ¿Ÿ"];
const GUA_ICON = ["ä·€","ä·","ä·‚","ä·ƒ","ä·„","ä·…","ä·†","ä·‡","ä·ˆ","ä·‰","ä·Š","ä·‹","ä·Œ","ä·","ä·","ä·","ä·","ä·‘","ä·’","ä·“","ä·”","ä·•","ä·–","ä·—","ä·˜","ä·™","ä·š","ä·›","ä·œ","ä·","ä·","ä·Ÿ","ä· ","ä·¡","ä·¢","ä·£","ä·¤","ä·¥","ä·¦","ä·§","ä·¨","ä·©","ä·ª","ä·«","ä·¬","ä·­","ä·®","ä·¯","ä·°","ä·±","ä·²","ä·³","ä·´","ä·µ","ä·¶","ä··","ä·¸","ä·¹","ä·º","ä·»","ä·¼","ä·½","ä·¾","ä·¿"];
const UP_LOW = [["ä¹¾","ä¹¾"], ["å¤","å¤"], ["å","éœ‡"], ["è‰®","å"], ["å","ä¹¾"], ["ä¹¾","å"], ["å¤","å"], ["å","å¤"], ["å·½","ä¹¾"], ["ä¹¾","å…‘"], ["å¤","ä¹¾"], ["ä¹¾","å¤"], ["ä¹¾","ç¦»"], ["ç¦»","ä¹¾"], ["å¤","è‰®"], ["éœ‡","å¤"], ["å…‘","éœ‡"], ["è‰®","å·½"], ["å¤","å…‘"], ["å·½","å¤"], ["ç¦»","éœ‡"], ["è‰®","ç¦»"], ["è‰®","å¤"], ["å¤","éœ‡"], ["ä¹¾","éœ‡"], ["è‰®","ä¹¾"], ["è‰®","éœ‡"], ["å…‘","å·½"], ["å","å"], ["ç¦»","ç¦»"], ["å…‘","è‰®"], ["éœ‡","å·½"], ["ä¹¾","è‰®"], ["éœ‡","ä¹¾"], ["ç¦»","å¤"], ["å¤","ç¦»"], ["å·½","ç¦»"], ["ç¦»","å…‘"], ["å","è‰®"], ["éœ‡","å"], ["è‰®","å…‘"], ["å·½","éœ‡"], ["å…‘","ä¹¾"], ["ä¹¾","å·½"], ["å…‘","å¤"], ["å¤","å·½"], ["å…‘","å"], ["å","å·½"], ["å…‘","ç¦»"], ["ç¦»","å·½"], ["éœ‡","éœ‡"], ["è‰®","è‰®"], ["å·½","è‰®"], ["éœ‡","å…‘"], ["éœ‡","ç¦»"], ["ç¦»","è‰®"], ["å·½","å·½"], ["å…‘","å…‘"], ["å·½","å"], ["å","å…‘"], ["å·½","å…‘"], ["éœ‡","è‰®"], ["å","ç¦»"], ["ç¦»","å"]];
const BAGUA_BIN = {"ä¹¾":7,"å…Œ":3,"ç¦»":5,"éœ‡":1,"å·½":6,"å":2,"è‰®":4,"å¤":0};

const ALT_NAMES = {
    "å°é":"å°è¿‡", "å°è¿‡":"å°é", "å¤§é":"å¤§è¿‡", "å¤§è¿‡":"å¤§é", "é¯":"é", "æ†":"æ’", "è¨Ÿ":"è®¼", "å¸«":"å¸ˆ", "è¬™":"è°¦", "è±«":"è±«", 
    "éš¨":"éš", "è ±":"è›Š", "è‡¨":"ä¸´", "è§€":"è§‚", "è³":"è´²", "å‰":"å‰¥", "å¾©":"å¤", "æ— å¦„":"æ— å¦„", "å¤§ç•œ":"å¤§ç•œ", "é ¤":"é¢", "ç¦»":"ç¦»", 
    "æ™‰":"æ™‹", "æ":"æŸ", "å¤¬":"å¤¬", "å§¤":"å§¤", "èƒ":"èƒ", "é©":"é©", "é¼":"é¼", "éœ‡":"éœ‡", "è‰®":"è‰®", "æ¼¸":"æ¸", "æ­¸å¦¹":"å½’å¦¹", "è±":"ä¸°", 
    "å·½":"å·½", "å…Œ":"å…‘", "æ¸™":"æ¶£", "ç¯€":"èŠ‚", "ä¸­å­š":"ä¸­å­š", "æ—¢æ¿Ÿ":"æ—¢æµ", "æœªæ¿Ÿ":"æœªæµ"
};

const VIZ = {
    ctxAstro: null, ctxLuo: null, w: 0, h: 0, frame: 0,
    sunLon: 0, jieqiList: [], curGong: 5, active: false,
    init: function() {
        const c1 = document.getElementById('canvas-astro');
        const c2 = document.getElementById('canvas-luoshu');
        if(!c1 || !c2) return;
        this.ctxAstro = c1.getContext('2d');
        this.ctxLuo = c2.getContext('2d');
        const resize = () => {
            if(!c1.parentElement) return;
            const rect = c1.parentElement.getBoundingClientRect();
            c1.width = rect.width; c1.height = rect.height;
            c2.width = rect.width; c2.height = rect.height;
            this.w = rect.width; this.h = rect.height;
        };
        window.addEventListener('resize', resize);
        resize();
        for(let i=0; i<24; i++) this.jieqiList.push(i * 15);
        this.active = true;
        this.loop();
    },
    updateData: function(sunLongitude, dunJu) {
        this.sunLon = sunLongitude || 0;
        this.curGong = dunJu ? dunJu.num : 5; 
    },
    loop: function() {
        if(!this.active) return;
        this.frame++;
        this.renderAstro();
        this.renderLuoShu();
        requestAnimationFrame(() => this.loop());
    },
    renderAstro: function() {
        const ctx = this.ctxAstro;
        const cx = this.w / 2, cy = this.h / 2;
        const R = Math.min(cx, cy) * 0.75;
        ctx.fillStyle = '#1a1a1e'; ctx.fillRect(0, 0, this.w, this.h);
        ctx.beginPath(); ctx.arc(cx, cy, R, 0, Math.PI*2); ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.stroke();
        ctx.save(); ctx.translate(cx, cy);
        this.jieqiList.forEach((deg, idx) => {
            const rad = (deg - 90) * Math.PI / 180;
            const isMajor = idx % 2 === 0;
            const r1 = R - (isMajor ? 10 : 5);
            const r2 = R + (isMajor ? 5 : 0);
            ctx.beginPath(); ctx.moveTo(Math.cos(rad)*r1, Math.sin(rad)*r1);
            ctx.lineTo(Math.cos(rad)*r2, Math.sin(rad)*r2);
            ctx.strokeStyle = isMajor ? '#666' : '#444'; ctx.stroke();
        });
        const sunRad = -this.sunLon * Math.PI / 180;
        const sx = Math.cos(sunRad) * R;
        const sy = Math.sin(sunRad) * R * -1;
        const glow = 10 + Math.sin(this.frame * 0.05) * 5;
        const grd = ctx.createRadialGradient(sx, sy, 2, sx, sy, glow);
        grd.addColorStop(0, '#fff'); grd.addColorStop(0.4, '#f1c40f'); grd.addColorStop(1, 'rgba(241, 196, 15, 0)');
        ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(sx, sy, glow, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(sx, sy, 4, 0, Math.PI*2); ctx.fill();
        ctx.restore();
        ctx.fillStyle = '#d4af37'; ctx.font = '12px Consolas'; ctx.textAlign = 'center';
        ctx.fillText(`é»„ç» ${this.sunLon.toFixed(4)}Â°`, cx, cy + R + 25);
    },
    renderLuoShu: function() {
        const ctx = this.ctxLuo;
        const cx = this.w / 2, cy = this.h / 2;
        const size = Math.min(this.w, this.h) * 0.6;
        const step = size / 3;
        ctx.fillStyle = 'rgba(26, 26, 30, 0.2)'; ctx.fillRect(0, 0, this.w, this.h);
        ctx.save(); ctx.translate(cx - size/2, cy - size/2);
        ctx.strokeStyle = '#333'; ctx.lineWidth = 1; ctx.beginPath();
        for(let i=0; i<=3; i++) { ctx.moveTo(i*step, 0); ctx.lineTo(i*step, size); ctx.moveTo(0, i*step); ctx.lineTo(size, i*step); }
        ctx.stroke();
        const getCenter = (idx) => {
             const map = { 1:[1,2], 2:[2,0], 3:[0,1], 4:[0,0], 5:[1,1], 6:[2,2], 7:[2,1], 8:[0,2], 9:[1,0] };
             const p = map[idx] || [1,1];
             return { x: p[1]*step + step/2, y: p[0]*step + step/2 };
        };
        ctx.beginPath();
        [1, 2, 3, 4, 5, 6, 7, 8, 9].forEach((n, i) => {
            const p = getCenter(n);
            if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
        });
        ctx.strokeStyle = 'rgba(52, 152, 219, 0.2)'; ctx.lineWidth = 2; ctx.stroke();
        const activeP = getCenter(this.curGong || 5);
        const pulse = 10 + Math.sin(this.frame * 0.1) * 5;
        ctx.strokeStyle = '#d4af37'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(activeP.x, activeP.y, 15 + pulse, 0, Math.PI*2); ctx.stroke();
        ctx.fillStyle = '#d4af37'; ctx.font = 'bold 14px KaiTi'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText("å¤ªä¸€", activeP.x, activeP.y);
        const time = this.frame * 0.01;
        const pos = (time % 9) + 1;
        const idx1 = Math.floor(pos);
        const idx2 = idx1 < 9 ? idx1 + 1 : 1;
        const ratio = pos - idx1;
        if(idx1 >=1 && idx1 <=9) {
            const p1 = getCenter(idx1);
            const p2 = getCenter(idx2);
            const px = p1.x + (p2.x - p1.x) * ratio;
            const py = p1.y + (p2.y - p1.y) * ratio;
            ctx.fillStyle = '#3498db'; ctx.shadowBlur = 10; ctx.shadowColor = '#3498db';
            ctx.beginPath(); ctx.arc(px, py, 4, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
        }
        ctx.restore();
    }
};

function b64ToUint8(b64) {
    const bin = window.atob(b64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return bytes;
}
function fmtJdLocal(jd) {
    const d = new Date((jd - 2440587.5) * 86400000);
    return d.toISOString().slice(11,19);
}
function getGuaBinary(name) {
    const idx = GUA_64.indexOf(name);
    if(idx<0) return 0;
    const ul = UP_LOW[idx];
    return ((BAGUA_BIN[ul[0]]||0) << 3) | (BAGUA_BIN[ul[1]]||0);
}
function getGuaNameByBin(bin) {
    for(let i=0; i<64; i++) if(getGuaBinary(GUA_64[i]) === bin) return GUA_64[i];
    return "ä¹¾";
}
function getLocation() {
    if(!navigator.geolocation) return alert("ä¸æ”¯æŒå®šä½");
    navigator.geolocation.getCurrentPosition(p => {
        document.getElementById('inp-lon').value = p.coords.longitude.toFixed(4);
        document.getElementById('inp-lat').value = p.coords.latitude.toFixed(4);
        calc();
    });
}
function lookupYilin(benName, zhiName) {
    if(!window.YILIN_BOOK) return null;
    let k = `${benName}ä¹‹${zhiName}`;
    if(window.YILIN_BOOK[k]) return window.YILIN_BOOK[k];
    const bAlt = ALT_NAMES[benName] || benName;
    const zAlt = ALT_NAMES[zhiName] || zhiName;
    const tries = [`${bAlt}ä¹‹${zAlt}`, `${benName}ä¹‹${zAlt}`, `${bAlt}ä¹‹${zhiName}`];
    for(let t of tries) if(window.YILIN_BOOK[t]) return window.YILIN_BOOK[t];
    if(window.YILIN_BOOK[benName] && window.YILIN_BOOK[benName][zhiName]) return window.YILIN_BOOK[benName][zhiName];
    if(window.YILIN_BOOK[benName] && window.YILIN_BOOK[benName][zAlt]) return window.YILIN_BOOK[benName][zAlt];
    if(window.YILIN_BOOK[bAlt] && window.YILIN_BOOK[bAlt][zhiName]) return window.YILIN_BOOK[bAlt][zhiName];
    return null;
}
function getLunar(targetJD) {
    let dz1 = core.findSolarTerm(targetJD - 100, 270); 
    if (dz1.jd > targetJD) dz1 = core.findSolarTerm(dz1.jd - 360, 270);
    let dz2 = core.findSolarTerm(dz1.jd + 370, 270);
    let cursor = core.findNewMoon(dz1.jd, -1, false, 0, 0);
    let moons = [];
    let ptr = cursor;
    for(let i=0; i<16; i++) {
        let next = core.findNewMoon(ptr + 5, 1, false, 0, 0);
        let hasZQ = false;
        let t1 = core.calcFourPillars(ptr + 0.5, 0, 0).sun_longitude;
        let t2 = core.calcFourPillars(next - 0.5, 0, 0).sun_longitude;
        if(t2 < t1) t2 += 360;
        let startK = Math.ceil(t1 / 30.0);
        let endK = Math.floor(t2 / 30.0);
        let dayStart = Math.floor(ptr + 0.5 + 8/24.0);
        let dayEnd = Math.floor(next + 0.5 + 8/24.0);
        for(let k=startK; k<=endK; k++) {
            let ang = (k * 30) % 360;
            let zqObj = core.findSolarTerm(ptr, ang);
            if (Math.abs(zqObj.jd - ptr) > 40) zqObj = core.findSolarTerm(ptr - 15, ang);
            let zqDay = Math.floor(zqObj.jd + 0.5 + 8/24.0);
            if(zqDay >= dayStart && zqDay < dayEnd) { hasZQ = true; break; }
        }
        moons.push({start: ptr, end: next, hasZQ: hasZQ});
        if(ptr > dz2.jd + 30) break;
        ptr = next;
    }
    let dz2Day = Math.floor(dz2.jd + 0.5 + 8/24.0);
    let monthsBetween = 0;
    for(let i=0; i<moons.length; i++) {
        let mStart = Math.floor(moons[i].start + 0.5 + 8/24.0);
        let mEnd = Math.floor(moons[i].end + 0.5 + 8/24.0);
        if(dz2Day >= mStart && dz2Day < mEnd) break;
        monthsBetween++;
    }
    let isLeapYear = (monthsBetween === 13);
    let nameIdx = 10; 
    let leapSet = false; 
    let targetDay = Math.floor(targetJD + 0.5 + 8/24.0);
    for(let i=0; i<moons.length; i++) {
        let m = moons[i];
        let isLeap = false;
        if(isLeapYear && !m.hasZQ && !leapSet && i > 0) { isLeap = true; leapSet = true; nameIdx--; }
        let mName = MONTH_CN[nameIdx % 12];
        if(isLeap) mName = "é—°" + mName;
        let mStart = Math.floor(m.start + 0.5 + 8/24.0);
        let mEnd = Math.floor(m.end + 0.5 + 8/24.0);
        if(targetDay >= mStart && targetDay < mEnd) {
            let diff = targetDay - mStart;
            return { str: `${mName}æœˆ${DAY_CN[diff]}`, log: `å†¬è‡³è·${monthsBetween}æœˆ, ${m.hasZQ?'å«':'æ— '}ä¸­æ°”${isLeap?', ç½®é—°':''}` };
        }
        nameIdx++;
    }
    return { str: "è®¡ç®—ä¸­", log: "" };
}

function calcDaYunPrecise(gz, jd, gender) {
    const yStemIdx = gz.year_gz % 10;
    const isYearYang = (yStemIdx % 2 === 0);
    const isMale = (gender === 1);
    const isForward = (isYearYang && isMale) || (!isYearYang && !isMale);
    let currentLon = gz.sun_longitude;
    let targetJd = 0;
    let scanAng = Math.floor(currentLon);
    for(let i=0; i<90; i++) {
        let nextAng = isForward ? (scanAng + 1) : (scanAng - 1);
        if(nextAng < 0) nextAng += 360;
        nextAng %= 360;
        let rem = nextAng % 30;
        if (Math.abs(rem - 15) < 0.5) { 
            let exactAng = nextAng;
            let res = core.findSolarTerm(jd, exactAng);
            if (isForward && res.jd <= jd) res = core.findSolarTerm(jd + 20, exactAng);
            else if (!isForward && res.jd >= jd) res = core.findSolarTerm(jd - 20, exactAng);
            targetJd = res.jd;
            break;
        }
        scanAng = nextAng;
    }
    if (targetJd === 0) targetJd = jd; 
    let diffDays = Math.abs(targetJd - jd);
    let valYears = diffDays / 3.0;
    let ageY = Math.floor(valYears);
    let remY = valYears - ageY;
    let ageM = Math.floor(remY * 12);
    let remM = (remY * 12) - ageM;
    let ageD = Math.floor(remM * 30);
    let startInfo = `${ageY}å²${ageM}ä¸ªæœˆ${ageD}å¤©`;
    let birthYear = new Date((jd - 2440587.5)*86400000).getFullYear();
    let list = [];
    let startMonth = gz.month_gz;
    for(let i=1; i<=8; i++) {
        let idx = isForward ? (startMonth + i) : (startMonth - i);
        if(idx<0) idx+=60;
        idx %= 60;
        let showAge = ageY + (i-1)*10;
        list.push({ gz: GAN[idx%10] + ZHI[idx%12], age: showAge });
    }
    return { dir: isForward?"é¡º":"é€†", info: startInfo, list: list };
}

function calc() {
    if(!core) return;
    const tStr = document.getElementById('inp-time').value;
    const d = new Date(tStr);
    const jd = (d.getTime()/86400000.0) + 2440587.5;
    const lon = parseFloat(document.getElementById('inp-lon').value);
    const lat = parseFloat(document.getElementById('inp-lat').value);
    const gender = parseInt(document.getElementById('inp-gender').value);
    
    const chart = core.calcChart(jd, lon, lat);
    const tst = core.calcTrueSolarTime(jd, lon, lat);
    const dt = core.getDeltaT(jd);
    
    // æ›´æ–°å¯è§†åŒ– (ä¿ç•™æ•°ç†/å¤©è±¡)
    VIZ.updateData(chart.gz.sun_longitude, { num: chart.ju.ju_num, type: chart.ju.dun_type });

    // è®¡ç®—
    const lunar = getLunar(jd);
    const dayun = calcDaYunPrecise(chart.gz, jd, gender);

    const y = GAN[chart.gz.year_gz%10] + ZHI[chart.gz.year_gz%12];
    const m = GAN[chart.gz.month_gz%10] + ZHI[chart.gz.month_gz%12];
    const dd = GAN[chart.gz.day_gz%10] + ZHI[chart.gz.day_gz%12];
    const hh = GAN[chart.gz.hour_gz%10] + ZHI[chart.gz.hour_gz%12];
    
    document.getElementById('header-info').innerHTML = `
        <div class="h-time">${tStr.replace('T',' ')}</div>
        <div class="h-solar">çœŸå¤ªé˜³æ—¶: ${fmtJdLocal(tst.jd_true)} | Î”T: ${dt.toFixed(1)}s</div>
        <div class="h-sub">${y}å¹´ ${m}æœˆ ${dd}æ—¥ ${hh}æ—¶ | ${chart.jieqi_str} | ${["ä¸Š","ä¸­","ä¸‹"][chart.ju.yuan]}å…ƒ${(chart.ju.dun_type===1?'é˜³':'é˜´')}${chart.ju.ju_num}å±€</div>
    `;

    document.getElementById('lunar-date').innerText = "å†œå†: " + lunar.str;
    document.getElementById('bz-y').innerText = y;
    document.getElementById('bz-m').innerText = m;
    document.getElementById('bz-d').innerText = dd;
    document.getElementById('bz-h').innerText = hh;
    document.getElementById('phy-log').innerText = `ç»åº¦:${lon}E | é»„ç»:${chart.gz.sun_longitude.toFixed(4)}Â° | å†œå†:${lunar.log}`;
    document.getElementById('qiyun-info').innerText = `${gender?'ä¹¾':'å¤'}é€  Â· ${dayun.dir}è¡Œ Â· ${dayun.info}`;
    
    let dyHtml = "";
    dayun.list.forEach(d => { dyHtml += `<div class="dy-card"><div class="dy-gz">${d.gz}</div><div class="dy-age">${d.age}</div></div>`; });
    document.getElementById('dayun-list').innerHTML = dyHtml;

    let benName, zhiName;
    if (document.getElementById('inp-method').value === 'guaqi') {
        const idx = Math.floor(((chart.gz.sun_longitude - 270 + 360)%360) / (360/64.0));
        benName = ["å¾©","é ¤","å±¯","ç›Š","éœ‡","å™¬å—‘","éš¨","æ— å¦„","æ˜å¤·","è³","æ—¢æ¿Ÿ","å®¶äºº","è±","ç¦»","é©","åŒäºº","è‡¨","æ","ç¯€","ä¸­å­š","æ­¸å¦¹","ç½","å…Œ","å±¥","æ³°","å¤§ç•œ","éœ€","å°ç•œ","å¤§å£¯","å¤§æœ‰","å¤¬","ä¹¾","å§¤","å¤§é","é¼","æ’","å·½","äº•","è ±","å‡","è¨Ÿ","å›°","æœªæ¿Ÿ","è§£","æ¸™","å","è’™","å¸«","é¯","å’¸","æ—…","å°é","æ¼¸","è¹‡","è‰®","è¬™","å¦","èƒ","æ™‰","è±«","è§€","æ¯”","å‰","å¤"][idx % 64];
        const movingLine = Math.floor(tst.jd_true * 1440) % 6;
        const benBin = getGuaBinary(benName);
        const zhiBin = benBin ^ (1 << movingLine);
        zhiName = getGuaNameByBin(zhiBin);
    } else {
        const sum = chart.gz.year_gz + chart.gz.month_gz + chart.gz.day_gz + chart.gz.hour_gz;
        benName = GUA_64[sum % 64];
        zhiName = GUA_64[(sum + (sum%6)) % 64];
    }
    
    document.getElementById('g-sym-ben').innerText = GUA_ICON[GUA_64.indexOf(benName)] || "?";
    document.getElementById('g-sym-zhi').innerText = GUA_ICON[GUA_64.indexOf(zhiName)] || "?";
    document.getElementById('g-name-ben').innerText = benName;
    document.getElementById('g-name-zhi').innerText = zhiName;
    
    const yiData = lookupYilin(benName, zhiName);
    document.getElementById('y-poem').innerText = yiData ? yiData.poem : "æŸ¥æ— æ­¤å¦";
    document.getElementById('y-desc').innerText = yiData ? yiData.desc : "ï¼ˆè¯·æ£€æŸ¥æ•°æ®æ–‡ä»¶æ˜¯å¦å®Œæ•´åŠ è½½ï¼‰";
}

createDunjiaCore({ wasmBinary: b64ToUint8(window.WASM_DATA) }).then(m => {
    m.FS.writeFile('/sepl_18.se1', b64ToUint8(window.EPHE_DATA));
    core = new m.DunjiaCore('/');
    document.getElementById('loading').style.display='none';
    document.getElementById('main-ui').style.display='flex';
    document.getElementById('inp-time').value = new Date(new Date().getTime()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,19);
    VIZ.init();
    calc();
});
</script>
</body>
</html>
"""

# === 5. æ‰§è¡Œ ===
def main():
    print("=== Dunjia V14 åˆç’§çº¯ç²¹ç‰ˆ (å»ç›˜ä¿ç•™å›¾) æ„å»º ===")
    wasm = read_b64(WASM_FILE)
    ephe = read_b64(EPHE_FILE)
    js = read_text(JS_FILE)
    yilin = process_data_logic()
    
    if not (wasm and ephe and js): 
        print("âŒ é”™è¯¯ï¼šç¼ºå°‘æ ¸å¿ƒæ–‡ä»¶ï¼")
        return

    html = HTML_TEMPLATE.replace("___WASM_PLACEHOLDER___", wasm) \
                        .replace("___EPHE_PLACEHOLDER___", ephe) \
                        .replace("___JS_PLACEHOLDER___", js) \
                        .replace("___YILIN_DATA_PLACEHOLDER___", yilin)

    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        f.write(html)
    
    print(f"âœ… æ„å»ºå®Œæˆ: {OUTPUT_FILE}")
    print("ç‰¹è‰²ï¼šæç®€ç¦…æ„ã€‚ä¿ç•™äº†å¤©è±¡å›¾ã€æ´›ä¹¦å›¾ã€å…«å­—ã€å†œå†ã€æ˜“æ—ã€‚ç§»é™¤äº†ä¹å®«æ–‡å­—ç›˜ã€‚")

if __name__ == "__main__":
    main()
